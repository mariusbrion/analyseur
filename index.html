<!DOCTYPE html>

<html lang="fr">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Analyseur de Distance Employ√©s & Audit Pro</title>

    

    <!-- Biblioth√®ques existantes -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    

    <!-- Biblioth√®ques pour l'export PDF -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>



    <style>

        /* --- STYLES EXISTANTS (INTACTS) --- */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }

        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); overflow: hidden; }

        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; text-align: center; color: white; }

        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); }

        .header p { font-size: 1.1rem; opacity: 0.9; }

        .content { padding: 40px; }

        .upload-section { text-align: center; margin-bottom: 40px; padding: 40px; border: 3px dashed #4facfe; border-radius: 15px; background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%); transition: all 0.3s ease; cursor: pointer; }

        .upload-section:hover { border-color: #00f2fe; background: linear-gradient(135deg, rgba(79, 172, 254, 0.2) 0%, rgba(0, 242, 254, 0.2) 100%); transform: translateY(-2px); }

        .upload-section.dragover { border-color: #00f2fe; background: linear-gradient(135deg, rgba(79, 172, 254, 0.3) 0%, rgba(0, 242, 254, 0.3) 100%); transform: scale(1.02); }

        .upload-icon { font-size: 4rem; color: #4facfe; margin-bottom: 20px; }

        .file-input { display: none; }

        .upload-btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3); }

        .upload-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4); }

        .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; }

        .toggle-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }

        .toggle-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }

        .toggle-btn.active { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); }

        .bike-btn { background: linear-gradient(135deg, #2ed573 0%, #17c0eb 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(46, 213, 115, 0.3); position: relative; overflow: hidden; }

        .bike-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(46, 213, 115, 0.4); }

        .bike-btn.active { background: linear-gradient(135deg, #ff9f43 0%, #ff6348 100%); box-shadow: 0 8px 25px rgba(255, 159, 67, 0.4); }

        .bike-btn::before { content: 'üö≤'; margin-right: 8px; }

        .chart-container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 30px; }

        .chart-title { text-align: center; font-size: 1.5rem; font-weight: 600; color: #333; margin-bottom: 20px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }

        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2); transition: transform 0.3s ease; }

        .stat-card:hover { transform: translateY(-5px); }

        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }

        .stat-label { font-size: 1rem; opacity: 0.9; }

        .loading { display: none; text-align: center; padding: 20px; }

        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4facfe; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: 600; }

        .success { background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%); color: white; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: 600; }

        #chartCanvas { max-height: 400px; }

        

        .map-container { margin-top: 40px; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }

        .map-title { text-align: center; font-size: 1.5rem; font-weight: 600; color: #333; margin-bottom: 20px; }

        .map-description { text-align: center; color: #666; margin-bottom: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }

        .map-iframe { border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border: none; overflow: hidden; }

        .map-customization { margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%); border-radius: 15px; border: 2px solid rgba(79, 172, 254, 0.3); }

        .map-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }

        .create-map-btn { background: linear-gradient(135deg, #2ed573 0%, #17c0eb 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(46, 213, 115, 0.3); text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }

        .create-map-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(46, 213, 115, 0.4); }

        .create-map-btn::before { content: 'üó∫Ô∏è'; }

        .reset-map-btn { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3); text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }

        .reset-map-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); }

        .reset-map-btn::before { content: 'üîÑ'; }

        .map-url-section { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }

        .map-url-input { flex: 1; min-width: 300px; padding: 12px 15px; border: 2px solid #4facfe; border-radius: 25px; font-size: 1rem; outline: none; transition: all 0.3s ease; }

        .map-url-input:focus { border-color: #00f2fe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2); }

        .load-map-btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3); white-space: nowrap; }

        .load-map-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4); }

        .load-map-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .instructions { margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; font-size: 0.9rem; color: #555; line-height: 1.5; }

        .instructions ol { margin: 10px 0; padding-left: 20px; }

        .instructions li { margin: 5px 0; }

        .map-status { text-align: center; margin-top: 10px; font-weight: 600; }

        .map-status.custom { color: #2ed573; }

        .map-status.demo { color: #ff9f43; }

        .guide-btn { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; border: none; padding: 12px 300px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(168, 237, 234, 0.3); text-decoration: none; display: inline-flex; align-items: center; gap: 8px; margin-top: 15px; }

        .guide-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(168, 237, 234, 0.4); }

        .guide-btn::before { content: 'üìñ'; }

        .signature { text-align: center; margin: 20px 0; opacity: 0; transform: translateY(20px); transition: all 0.6s ease 0.3s; }

        .signature a { display: inline-block; color: rgba(255,255,255,0.8); font-size: 0.9rem; letter-spacing: 1px; padding: 8px 20px; border-radius: 20px; background: rgba(0,0,0,0.1); backdrop-filter: blur(3px); text-decoration: none; transition: all 0.3s ease; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        .signature a:hover { background: rgba(102, 126, 234, 0.3); color: white; transform: translateY(-2px); }

        

        /* --- STYLE PDF BOUTON --- */

        .pdf-btn {

            background: linear-gradient(135deg, #4facfe 0%, #4facfe 100%);

            color: white;

            border: none;

            padding: 12px 25px;

            border-radius: 25px;

            font-size: 1rem;

            font-weight: 600;

            cursor: pointer;

            transition: all 0.3s ease;

            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);

            display: inline-flex;

            align-items: center;

            gap: 8px;

        }

        .pdf-btn:hover {

            transform: translateY(-2px);

            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);

            filter: brightness(1.1);

        }

        .pdf-btn::before { content: 'üìÑ'; }

        

        @media (max-width: 768px) {

            .signature { margin: 20px 10px; }

            .guide-btn { width: 100%; padding: 12px; justify-content: center; }

        }

    </style>

</head>

<body>

    <div class="container">

        <div class="header">

            <h1>üìä Analyseur de Distance Employ√©s</h1>

            <p>Visualisez les donn√©es de distance et temps de trajet de vos employ√©s</p>

        </div>

        

        <div class="content">

            <div class="upload-section" id="uploadSection">

                <div class="upload-icon">üìÅ</div>

                <h3>Importez votre fichier CSV</h3>

                <p>Glissez-d√©posez votre fichier ou cliquez pour le s√©lectionner</p>

                <input type="file" id="fileInput" class="file-input" accept=".csv" />

                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">

                    Choisir un fichier

                </button>

            </div>



            <div class="loading" id="loading">

                <div class="spinner"></div>

                <p>Traitement des donn√©es en cours...</p>

            </div>



            <div class="controls" id="controls" style="display: none;">

                <button class="toggle-btn active" id="distanceBtn">Distance (km)</button>

                <button class="toggle-btn" id="timeBtn">Temps de trajet (min)</button>

                <button class="bike-btn" id="bikeBtn" style="display: none;">V√©lo √©lectrique (-25%)</button>

                <button class="pdf-btn" id="pdfBtn">Export Audit PDF</button>

            </div>



            <div class="chart-container" id="chartContainer" style="display: none;">

                <h3 class="chart-title" id="chartTitle">Distribution par Distance</h3>

                <canvas id="chartCanvas"></canvas>

            </div>



            <div class="stats-grid" id="statsGrid" style="display: none;"></div>



            <!-- Section pour la carte -->

            <div class="map-container">

                <h3 class="map-title">Carte des Zones de Passage des V√©los</h3>

                <p class="map-description">

                    Cette carte montre les zones o√π les passages de v√©los sont les plus fr√©quents. 

                </p>



                <!-- Section de personnalisation de la carte -->

                <div class="map-customization">

                    <div class="map-buttons">

                        <a href="http://studio.foursquare.com/map/" target="_blank" class="create-map-btn">

                            Cr√©er ma carte personnalis√©e

                        </a>

                        <button class="reset-map-btn" id="resetMapBtn">

                            Revenir √† la carte par d√©faut

                        </button>

                    </div>



                    <div class="map-url-section">

                        <input 

                            type="url" 

                            id="mapUrlInput" 

                            class="map-url-input" 

                            placeholder="Collez ici le lien de votre carte Foursquare Studio"

                        />

                        <button class="load-map-btn" id="loadMapBtn">

                            Charger ma carte

                        </button>

                    </div>



                    <div class="instructions">

                        <a href="https://mariusbrion.github.io/guide_carte/" target="_blank" class="guide-btn">

                            Guide pour cr√©er votre carte personnalis√©e

                        </a>

                    </div>

                </div>



                <div class="map-status demo" id="mapStatus">

                    üìç Affichage de la carte de d√©monstration

                </div>

                

                <iframe 

                    id="mapIframe"

                    class="map-iframe"

                    width="100%" 

                    height="500px" 

                    src="https://studio.foursquare.com/map/public/1318295f-ba13-40df-a6d1-ea3315570c76/embed" 

                    frameborder="0" 

                    allowfullscreen>

                </iframe>

            </div>

        </div>

    </div>



    <!-- Signature avec lien vers portfolio -->

    <div class="signature">

        <a href="https://mariusbrion.github.io/portfolio/" target="_blank">

            <span style="font-weight:500">Design & d√©veloppement</span> 

            <span style="font-weight:600;color:#fff;margin-left:4px">Marius Brion</span>

        </a>

    </div>



    <!-- Conteneur cach√© pour la g√©n√©ration de graphiques PDF -->

    <div id="pdf-hidden-generator" style="position: absolute; left: -9999px; top: -9999px;"></div>



    <script>

        let csvData = [];

        let currentChart = null;

        let currentMode = 'distance';

        let bikeMode = false;



        const fileInput = document.getElementById('fileInput');

        const uploadSection = document.getElementById('uploadSection');

        const loading = document.getElementById('loading');

        const controls = document.getElementById('controls');

        const chartContainer = document.getElementById('chartContainer');

        const statsGrid = document.getElementById('statsGrid');

        const distanceBtn = document.getElementById('distanceBtn');

        const timeBtn = document.getElementById('timeBtn');

        const bikeBtn = document.getElementById('bikeBtn');

        const chartTitle = document.getElementById('chartTitle');

        

        const mapUrlInput = document.getElementById('mapUrlInput');

        const loadMapBtn = document.getElementById('loadMapBtn');

        const mapIframe = document.getElementById('mapIframe');

        const mapStatus = document.getElementById('mapStatus');

        const resetMapBtn = document.getElementById('resetMapBtn');

        const pdfBtn = document.getElementById('pdfBtn');



        function isLocalStorageAvailable() {

            try {

                const test = '__test__';

                localStorage.setItem(test, test);

                localStorage.removeItem(test);

                return true;

            } catch (e) {

                return false;

            }

        }



        uploadSection.addEventListener('dragover', (e) => {

            e.preventDefault();

            uploadSection.classList.add('dragover');

        });



        uploadSection.addEventListener('dragleave', () => {

            uploadSection.classList.remove('dragover');

        });



        uploadSection.addEventListener('drop', (e) => {

            e.preventDefault();

            uploadSection.classList.remove('dragover');

            const files = e.dataTransfer.files;

            if (files.length > 0) {

                handleFile(files[0]);

            }

        });



        fileInput.addEventListener('change', (e) => {

            if (e.target.files.length > 0) {

                handleFile(e.target.files[0]);

            }

        });



        loadMapBtn.addEventListener('click', loadCustomMap);

        mapUrlInput.addEventListener('input', validateMapUrl);



        resetMapBtn.addEventListener('click', () => {

            mapIframe.src = 'https://studio.foursquare.com/map/public/1318295f-ba13-40df-a6d1-ea3315570c76/embed';

            mapStatus.textContent = 'üìç Affichage de la carte de d√©monstration';

            mapStatus.className = 'map-status demo';

            mapUrlInput.value = '';

            if (isLocalStorageAvailable()) {

                localStorage.removeItem('customMapData');

            }

        });



        function validateMapUrl() {

            const url = mapUrlInput.value.trim();

            const isValid = url && (url.includes('studio.foursquare.com') || url.includes('foursquare.com'));

            loadMapBtn.disabled = !isValid;

        }



        function loadCustomMap() {

            const url = mapUrlInput.value.trim();

            let embedUrl = url;

            if (url.includes('studio.foursquare.com/map/public/') && !url.includes('/embed')) {

                const mapId = url.match(/\/public\/([a-f0-9-]+)/);

                if (mapId) embedUrl = `https://studio.foursquare.com/map/public/${mapId[1]}/embed`;

            }

            mapIframe.src = embedUrl;

            mapStatus.textContent = '‚úÖ Votre carte personnalis√©e est charg√©e';

            mapStatus.className = 'map-status custom';

        }



        function handleFile(file) {

            loading.style.display = 'block';

            uploadSection.style.display = 'none';

            Papa.parse(file, {

                header: true,

                skipEmptyLines: true,

                dynamicTyping: true,

                complete: function(results) {

                    csvData = results.data.filter(row => row.id && !isNaN(parseFloat(row.distance_km)));

                    loading.style.display = 'none';

                    controls.style.display = 'flex';

                    updateChart();

                }

            });

        }



        distanceBtn.addEventListener('click', () => {

            currentMode = 'distance';

            distanceBtn.classList.add('active');

            timeBtn.classList.remove('active');

            bikeBtn.style.display = 'none';

            updateChart();

        });



        timeBtn.addEventListener('click', () => {

            currentMode = 'time';

            timeBtn.classList.add('active');

            distanceBtn.classList.remove('active');

            bikeBtn.style.display = 'block';

            updateChart();

        });



        bikeBtn.addEventListener('click', () => {

            bikeMode = !bikeMode;

            bikeBtn.classList.toggle('active');

            bikeBtn.textContent = bikeMode ? 'üö≤ V√©lo √©lectrique activ√© (-25%)' : 'üö≤ V√©lo √©lectrique (-25%)';

            updateChart();

        });



        function categorizeData() {

            const categories = {};

            const total = csvData.length;

            if (currentMode === 'distance') {

                categories['0-2 km'] = 0; categories['2-5 km'] = 0; categories['5-10 km'] = 0; categories['10+ km'] = 0;

                csvData.forEach(row => {

                    const d = parseFloat(row.distance_km);

                    if (d <= 2) categories['0-2 km']++; else if (d <= 5) categories['2-5 km']++; else if (d <= 10) categories['5-10 km']++; else categories['10+ km']++;

                });

            } else {

                categories['0-10 min'] = 0; categories['10-15 min'] = 0; categories['15-20 min'] = 0; categories['20+ min'] = 0;

                csvData.forEach(row => {

                    let d = parseFloat(row.duration_minutes);

                    if (bikeMode) d *= 0.75;

                    if (d <= 10) categories['0-10 min']++; else if (d <= 15) categories['10-15 min']++; else if (d <= 20) categories['15-20 min']++; else categories['20+ min']++;

                });

            }

            const percentages = {};

            Object.keys(categories).forEach(k => percentages[k] = (categories[k]/total)*100);

            return { categories, percentages, total };

        }



        function updateChart() {

            const { categories, percentages, total } = categorizeData();

            chartTitle.textContent = currentMode === 'distance' ? 'Distribution par Distance' : 'Distribution par Temps';

            const ctx = document.getElementById('chartCanvas').getContext('2d');

            if (currentChart) currentChart.destroy();

            currentChart = new Chart(ctx, {

                type: 'bar',

                data: {

                    labels: Object.keys(categories),

                    datasets: [{

                        data: Object.values(percentages),

                        backgroundColor: '#4facfe',

                        borderRadius: 10

                    }]

                },

                options: { 

                    responsive: true, 

                    maintainAspectRatio: false, 

                    plugins: { legend: { display: false } }, // Restauration du masquage de la l√©gende

                    scales: { y: { max: 100 } } 

                }

            });

            updateStats(categories, total, Object.values(percentages));

            chartContainer.style.display = 'block';

            statsGrid.style.display = 'grid';

        }



        function updateStats(categories, total, percentages) {

            statsGrid.innerHTML = '';

            Object.keys(categories).forEach((k, i) => {

                const card = document.createElement('div');

                card.className = 'stat-card';

                card.innerHTML = `<div class="stat-value">${Object.values(categories)[i]}</div><div class="stat-label">${k}<br>(${percentages[i].toFixed(1)}%)</div>`;

                statsGrid.appendChild(card);

            });

        }



        // -------------------------------------------------------------

        // --- NOUVELLES FONCTIONS PDF MISE √Ä JOUR ---

        // -------------------------------------------------------------



        pdfBtn.addEventListener('click', exportFullAuditPDF);



        async function exportFullAuditPDF() {

            if (csvData.length === 0) return;

            pdfBtn.textContent = "G√©n√©ration...";

            pdfBtn.disabled = true;



            try {

                const { jsPDF } = window.jspdf;

                const doc = new jsPDF();

                const pageWidth = doc.internal.pageSize.getWidth();

                const pageHeight = doc.internal.pageSize.getHeight();

                const margin = 20;

                const softBlue = [79, 172, 254]; // Bleu clair moderne



                // Fonction pour ajouter le footer sur chaque page

                const addFooter = () => {

                    const footerText = "Outil d√©velopp√© dans le cadre du CAVENA, faisant partie des moyens de diagnostic valid√©s par la FUB pour la certification du label Employeur Pro V√©lo.";

                    doc.setFont("helvetica", "normal");

                    doc.setFontSize(8);

                    doc.setTextColor(150, 150, 150);

                    // On split le texte si trop long, mais ici √ßa devrait tenir

                    const splitFooter = doc.splitTextToSize(footerText, pageWidth - (margin * 2));

                    doc.text(splitFooter, pageWidth / 2, pageHeight - 12, { align: 'center' });

                };



                // --- PAGE 1: COUVERTURE ---

                doc.setFillColor(255, 255, 255); 

                doc.rect(0, 0, pageWidth, 40, 'F');

                

                doc.setTextColor(...softBlue); 

                doc.setFontSize(22);

                doc.setFont("helvetica", "bold");

                doc.text("Rapport de diagnostic de mobilit√©", pageWidth / 2, 25, { align: 'center' });

                

                doc.setTextColor(80, 80, 80);

                doc.setFontSize(12);

                doc.setFont("helvetica", "normal");

                doc.text(`Rapport g√©n√©r√© le ${new Date().toLocaleDateString()} par l'outil Marius`, margin, 55);

                doc.text(`Effectif analys√© : ${csvData.length} collaborateurs`, margin, 62);

                

                doc.setDrawColor(...softBlue);

                doc.line(margin, 70, pageWidth - margin, 70);



                // --- ANALYSE DISTANCE ---

                const distStats = analyzeForReport('distance', false);

                const distImg = await generateInvisibleChart('Distances', distStats, '#4facfe');

                

                doc.setFontSize(14);

                doc.setTextColor(...softBlue);

                doc.setFont("helvetica", "bold");

                doc.text("1. ANALYSE DES DISTANCES", margin, 85);

                

                doc.addImage(distImg, 'PNG', margin, 90, pageWidth - (margin*2), 70);

                

                // Commentaire Distance Nuanc√©

                const distComment = generateDistanceComment(distStats);

                doc.setFont("helvetica", "italic");

                doc.setFontSize(10);

                doc.setTextColor(100, 100, 100);

                const splitDist = doc.splitTextToSize(distComment, pageWidth - (margin*2));

                doc.text(splitDist, margin, 165);

                

                addFooter();



                // --- PAGE 2: ANALYSE TEMPS ---

                doc.addPage();

                

                doc.setFontSize(14);

                doc.setTextColor(...softBlue);

                doc.setFont("helvetica", "bold");

                doc.text("2. ANALYSE DES TEMPS DE TRAJET", margin, 20);

                

                // Graphique 1 : V√©lo Musculaire

                const timeStats = analyzeForReport('time', false);

                const timeImg = await generateInvisibleChart('Temps Musculaire', timeStats, '#4facfe');

                

                doc.setFontSize(10);

                doc.setTextColor(80, 80, 80);

                doc.text("Situation actuelle (V√©lo Musculaire / Standard)", margin, 30);

                doc.addImage(timeImg, 'PNG', margin, 32, pageWidth - (margin*2), 65);

                

                // Commentaire Temps Nuanc√©

                const timeBikeStats = analyzeForReport('time', true);

                const timeComment = generateTimeComment(timeStats, timeBikeStats);

                doc.setFont("helvetica", "italic");

                doc.setTextColor(100, 100, 100);

                const splitTime = doc.splitTextToSize(timeComment, pageWidth - (margin*2));

                doc.text(splitTime, margin, 105);



                // Graphique 2 : V√©lo √âlectrique

                const timeBikeImg = await generateInvisibleChart('Temps √âlectrique', timeBikeStats, '#2ed573');

                

                doc.setFont("helvetica", "bold");

                doc.setTextColor(46, 213, 115); // Vert √©lectrique

                doc.text("Projection comparative avec Assistance √âlectrique (VAE)", margin, 140);

                

                doc.addImage(timeBikeImg, 'PNG', margin, 142, pageWidth - (margin*2), 65);

                

                addFooter();



                // --- PAGE 3: CARTE ---

                doc.addPage();

                doc.setFontSize(14);

                doc.setTextColor(...softBlue);

                doc.text("3. CARTE DE CHALEUR DES FLUX", margin, 30);

                

                doc.setDrawColor(220, 220, 220);

                doc.rect(margin, 40, pageWidth - (margin*2), 100);

                doc.setFontSize(10);

                doc.setTextColor(180, 180, 180);

                doc.text("Ins√©rer ici la capture d'√©cran de l'interface interactive", pageWidth/2, 90, {align:'center'});



                addFooter();



                doc.save("Diagnostic_Mobilite_Marius.pdf");

                showSuccess("PDF g√©n√©r√© avec succ√®s !");

            } catch (e) {

                console.error(e);

                showError("Erreur PDF.");

            } finally {

                pdfBtn.textContent = "Export Audit PDF";

                pdfBtn.disabled = false;

            }

        }



        function analyzeForReport(mode, isBike) {

            const categories = {};

            const total = csvData.length;

            if (mode === 'distance') {

                categories['0-2 km'] = 0; categories['2-5 km'] = 0; categories['5-10 km'] = 0; categories['10+ km'] = 0;

                csvData.forEach(row => {

                    const d = parseFloat(row.distance_km);

                    if (d <= 2) categories['0-2 km']++; else if (d <= 5) categories['2-5 km']++; else if (d <= 10) categories['5-10 km']++; else categories['10+ km']++;

                });

            } else {

                categories['0-10 min'] = 0; categories['10-15 min'] = 0; categories['15-20 min'] = 0; categories['20+ min'] = 0;

                csvData.forEach(row => {

                    let d = parseFloat(row.duration_minutes);

                    if (isBike) d *= 0.75;

                    if (d <= 10) categories['0-10 min']++; else if (d <= 15) categories['10-15 min']++; else if (d <= 20) categories['15-20 min']++; else categories['20+ min']++;

                });

            }

            const percentages = {};

            Object.keys(categories).forEach(k => percentages[k] = (categories[k]/total)*100);

            return { categories, percentages, total };

        }



        function generateInvisibleChart(label, stats, color = '#4facfe') {

            return new Promise((resolve) => {

                const container = document.getElementById('pdf-hidden-generator');

                const canvas = document.createElement('canvas');

                canvas.width = 800; canvas.height = 400;

                container.appendChild(canvas);

                new Chart(canvas.getContext('2d'), {

                    type: 'bar',

                    data: {

                        labels: Object.keys(stats.categories),

                        datasets: [{ 

                            data: Object.values(stats.percentages), 

                            backgroundColor: color,

                            borderRadius: 6

                        }]

                    },

                    options: { 

                        animation: false, 

                        responsive: false,

                        plugins: { legend: { display: false } },

                        scales: { y: { beginAtZero: true, max: 100 } } 

                    }

                });

                setTimeout(() => {

                    const data = canvas.toDataURL('image/png');

                    container.innerHTML = '';

                    resolve(data);

                }, 200);

            });

        }



        // --- GENERATION DES COMMENTAIRES NUANC√âS (MIS √Ä JOUR) ---



        function generateDistanceComment(stats) {

            const shortDist = stats.percentages['0-2 km'] + stats.percentages['2-5 km'];

            const mediumDist = stats.percentages['5-10 km'];

            const under10 = shortDist + mediumDist;



            let text = `Analyse de la r√©partition g√©ographique : ${shortDist.toFixed(1)}% des effectifs r√©sident √† moins de 5km du site. `;



            if (shortDist > 30) {

                text += "Ceci repr√©sente un gisement tr√®s important pour le report modal vers le v√©lo musculaire ou √©lectrique. ";

                text += `Concr√®tement, cela concerne environ ${Math.round((shortDist/100)*stats.total)} collaborateurs qui pourraient abandonner la voiture individuelle. `;

            } else if (shortDist > 15) {

                text += "Un potentiel mod√©r√© mais existant pour la mobilit√© douce de proximit√©. ";

            } else {

                text += "L'√©loignement g√©ographique est marqu√© sur la tr√®s courte distance. ";

            }



            // Nuance 5-10km (Urban/Comp√©titif)

            if (mediumDist > 10 || under10 > 40) {

                text += `Si l'on √©largit le p√©rim√®tre, notons que ${under10.toFixed(1)}% des effectifs se situent √† moins de 10km. `;

                text += "En milieu urbain, ce sont des distances (5-10km) o√π le v√©lo est souvent plus comp√©titif que la voiture en temps de trajet r√©el, tout en restant r√©alisable par la tr√®s grande majorit√© de la population, particuli√®rement avec l'assistance √©lectrique. ";

            } else {

                text += "Au-del√† de 10km, le covoiturage ou les transports en commun deviennent des options strat√©giques plus pertinentes. ";

            }



            return text;

        }



        function generateTimeComment(normalStats, bikeStats) {

            const totalEmployees = normalStats.total;

            const under15Car = normalStats.percentages['0-10 min'] + normalStats.percentages['10-15 min'];

            const under15Bike = bikeStats.percentages['0-10 min'] + bikeStats.percentages['10-15 min'];

            const under20Bike = under15Bike + bikeStats.percentages['15-20 min'];

            const countUnder20Bike = Math.round((under20Bike / 100) * totalEmployees);

            

            let text = `Impact du temps de trajet : Actuellement, ${under15Car.toFixed(1)}% des trajets sont inf√©rieurs √† 15 minutes. `;

            

            if (under15Bike > under15Car) {

                const gain = (under15Bike - under15Car).toFixed(1);

                text += `L'introduction du v√©lo √©lectrique permettrait d'augmenter cette proportion de +${gain} points. `;

                

                // Nuance interm√©diaire 15-20 min ou faible proportion < 15min

                if (under15Bike < 15) {

                    text += `Bien que la part des trajets de moins de 15 minutes reste modeste, l'assistance √©lectrique permettrait √† ${countUnder20Bike} employ√©s de se rendre au travail en moins de 20 minutes. Ce temps de trajet reste extr√™mement cr√©dible et attractif pour la grande majorit√© de la population. `;

                } else {

                    text += `Concr√®tement, l'assistance √©lectrique permettrait √† ${countUnder20Bike} employ√©s de se rendre au travail en moins de 20 minutes. `;

                }



                text += "Le gain de fluidit√© et la r√©duction de la fatigue li√©e aux embouteillages sont des facteurs cl√©s de qualit√© de vie au travail (QVT). Le v√©lo √©lectrique nivelle les temps de parcours en s'affranchissant des al√©as du trafic automobile.";

            } else {

                text += `Le passage au v√©lo √©lectrique maintient des temps de parcours comp√©titifs en permettant √† ${countUnder20Bike} employ√©s de se rendre au travail en moins de 20 minutes tout en garantissant une pr√©dictibilit√© des horaires d'arriv√©e et une r√©gularit√© pr√©cieuse pour les collaborateurs. `;

                

                if (under15Bike < 10 && under20Bike > 30) {

                    text += "M√™me si les trajets de moins de 15 minutes sont peu nombreux, la dur√©e de moins de 20 minutes constitue un seuil de basculement tr√®s r√©aliste pour la grande majorit√© de la population active.";

                }

            }

            return text;

        }

    </script>

</body>

</html>
